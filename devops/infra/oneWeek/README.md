## 서버 / 인프라 구축 입문

#### 다중화/부하분산의 기본

```
1.1 다중화의 기본
다중화란
- 다중화란, 장애가 발생해도 예비 운용장비로 시스템의 기능을 계속할 수 있도록 하는 것을 말한다.

다중화의 본질
1) 장애를 상정한다.
- 라우터/서버 등 장애
2) 장애에 대비해서 예비 운용장비를 준비한다.
3) 장애가 발생했을 때 예비 운용장비로 교체할 수 있는 운용체제를 정비한다.
- 라우터 장애 대응(Cold Standby)
  물리적으로 회선 연결을 변경하거나 전원을 투입
  네트워크 장비는 설정 변경이 빈번하지 않으므로 가능함
- 서버 장애 대응(Hot Standby)  
  항상 전원을 켜두고 네트워크에 연결해두는 것이 좋다.
  현재 운용장비의 내용을 갱신할 때에 같이 갱신되어야 한다.

장애극복
웹서비스는 VIP를 할당하여, 장애 발생시 예비 운용장비가 VIP를 인계한다.

장애검출
ICMP/Port/HTTP 등을 요청하여 응답여부 체크

Active/Backup 구성 만들기
/// 구성
/// ARP 에 대하여 (GARP)

서버를 효과적으로 활용하자
- LB로 구성하는 것이 더 효과적이다.
```

```
1.2 웹 서버의 다중화
DNS 라운드로빈
- DNS를 이용해서 하나의 서비스에 여러 대의 서버를 분산시키는 방법
  DNS 서버는 동일한 이름으로 여러 레코드를 등록시키면 질의할 때마다 다른 결과를 반환한다. 다만, 이 경우 1)서버의 수만큼 IP주소가 필요 2)균등하게 분산되지 않음(캐싱, 프록시 서버 경유 등) 3)서버가 다운되어도 감지하지 못함
  
DNS 라운드로빈의 다중화 구성 예
/// 구성
보다 편하게 시스템 확장하기
- 서버가 3대가 되었을 경우
  어떤 서버가 VIP를 인계할지
  두 대의 서버가 같은 IP를 지닐 가능성
  한번 정지한 서버를 복귀시키기 곤란
```

```
1.3 웹 서버의 다중화
DNS 라운드로빈과 로드밸런서의 차이
- 로드밸런서는 하나의 IP주소에 대해 요청을 복수의 서버로 분산할 수 있다. 
  클라이언트로부터 전송되어 온 요청을 실제 웹 서버로 중계함으로써 자신이 웹서버인 것처럼 동작한다.
  
IPVS
- 이 책의 LB는 L4를 의미
  L4SW의 경우 IP주소나 포트번호에 따라 분산대상 서버를 지정할 수 있음
  L7SW의 경우 URL에 따라 분산대상 서버를 지정할 수 있음

스케줄링 알고리즘
- rr : 모든 서버 균등
- wrr : 가중치 부여
- lc : ESTABLSHED/TIME_WAIT/FIN_WAIT인 접속수가 가장 적은 서버
- wlc : wrr + lc
- sed : ESTABLSHED인 접속수가 가장 적은 서버
- nq : sed (+ active가 0인 서버 최우선)

IPVS 사용하기
- ipvsadm : command tool
            가상서버를 정의하고 리얼서버를 할당
            설정내용/접속상황/전송률 등을 확인
- keepalived : 설정파일을 기준으로 IPVS의 가상서버를 구축
               다운된 서버를 부하분산에서 제외
               모두 다운되었을 경우 에러 메시지 전송
               
로드밸런서 구축하기
// keepalived 구성

L4스위치와 L7스위치
- L4SW에서는 클라이언트가 통신하는 곳은 리얼서버지만, 
  L7SW에서는 로드밸런서와 클라이언트가 TCP 세션을 전개한다.
  
L4스위치의 NAT구성과 DSR구성
- NAT는 패킷의 수신지 주소를 변경하지만, DSR은 IP주소를 변경하지 않음
// NAT vs DSR vs DNAT

동일 서브넷인 서버를 부하분산할 경우 주의사항
```

```
1.4 라우터 및 로드밸런서의 다중화
다중화란
다중화 프로토콜 VRRP
- HSRP vs VRRP

VRRP의 구조
keepalived의 구조상의 문제
keepalived 다중화
keepalived 응용
```

